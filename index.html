<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="alternate icon" type="image/png" href="favicon.png">
  <title>Esports Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-body: #020617;
      --bg-card: #0f172a;
      --border-soft: #1e293b;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #3b82f6;

      --disc-cs2: #3b82f6;
      --disc-dota2: #ef4444;
      --disc-valorant: #a855f7;
      --disc-efootball: #6fbe8c;
      --disc-lol: #f97316;
      --disc-football: #22d3ee;
      --disc-projectd: #b7ff00;
      --disc-other: #f59e0b;

      --gantt-day-width: 26px;
      --gantt-row-height: 22px;
      --gantt-sidebar-width: 220px;
      --gantt-sidebar-width-collapsed: 28px;
      --calendar-row-height: 88px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      height: 100%;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      color: var(--text-main);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 24px;
      overflow: hidden;
    }

    .app-shell {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 16px;
      flex-shrink: 0;
    }

    .app-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-dot {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: conic-gradient(from 140deg,#3b82f6,#a855f7,#22c55e,#f97316,#3b82f6);
      box-shadow: 0 0 20px rgba(59,130,246,0.6);
    }

    .app-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .app-title-main { font-size: 18px; font-weight: 600; letter-spacing: 0.03em; }
    .app-title-sub  { font-size: 12px; color: var(--text-muted); }

    .app-header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
      color: var(--text-main);
      font-size: 12px;
      padding: 5px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      outline: none;
      transition: border-color 0.12s ease, background 0.12s ease,
        transform 0.07s ease, opacity 0.12s ease;
    }
    .btn:hover {
      border-color: rgba(248,250,252,0.9);
      background: rgba(15,23,42,1);
      transform: translateY(-0.5px);
    }
    .btn:active { transform: translateY(0.5px) scale(0.99); }

    .btn-secondary {
      padding-inline: 8px;
      font-size: 11px;
      border-radius: 999px;
    }

    .btn-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .btn-icon-only {
      padding-inline: 6px;
      width: 28px;
      justify-content: center;
    }

    .calendar-card {
      border-radius: 20px;
      background: radial-gradient(circle at top,#1f2937 0,#020617 65%);
      border: 1px solid rgba(148,163,184,0.22);
      box-shadow: 0 24px 70px rgba(15,23,42,0.9);
      padding: 16px 18px 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
      min-height: 0;
      position: relative;
    }

    .loading-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: radial-gradient(circle at top, rgba(15,23,42,0.96), #020617 110%);
  font-size: 13px;
  color: var(--text-muted);
  z-index: 50;
  pointer-events: none;
}

.loading-overlay--hidden {
  display: none;
}

.loading-inner {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.loading-spinner {
  width: 32px;
  height: 32px;
  border-radius: 999px;
  border: 3px solid rgba(148,163,184,0.35);
  border-top-color: var(--accent);
  animation: loading-spin 0.7s linear infinite;
  box-shadow: 0 0 20px rgba(15,23,42,0.9);
}

.loading-text {
  font-size: 11px;
  color: var(--text-muted);
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

@keyframes loading-spin {
  to {
    transform: rotate(360deg);
  }
}



    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
      gap: 12px;
      flex-shrink: 0;
    }

    .month-caption { display: flex; flex-direction: column; gap: 2px; }
    .month-name    { font-size: 17px; font-weight: 600; }
    .month-range   { font-size: 12px; color: var(--text-muted); }

    .calendar-header-right {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }

    .nav-row {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

    .nav-buttons {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .view-toggle {
      display: inline-flex;
      padding: 2px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.45);
      background: rgba(15,23,42,0.9);
    }

    .view-pill {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: background 0.12s ease, color 0.12s ease;
    }
    .view-pill--active { background: rgba(15,23,42,1); color: var(--text-main); }

    .gantt-range-toggle { margin-left: 6px; }

    .discipline-legend {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
      font-size: 10px;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.2);
      background: rgba(15,23,42,0.9);
      cursor: pointer;
      outline: none;
      color: var(--text-main);
      font-size: 10px;
    }
    .legend-item--inactive { opacity: 0.3; }

    .legend-swatch { width: 10px; height: 10px; border-radius: 3px; }

    .legend-all      { background: linear-gradient(90deg,#3b82f6,#ef4444,#a855f7); }
    .legend-cs2      { background: var(--disc-cs2); }
    .legend-dota2    { background: var(--disc-dota2); }
    .legend-valorant { background: var(--disc-valorant); }
    .legend-efootball{ background: var(--disc-efootball); }
    .legend-lol      { background: var(--disc-lol); }
    .legend-football { background: var(--disc-football); }
    .legend-projectd { background: var(--disc-projectd); }
    .legend-other    { background: var(--disc-other); }

    .zoom-controls { display: flex; gap: 4px; align-items: center; }
    .zoom-label { font-size: 10px; color: var(--text-muted); margin-right: 2px; }

    .calendar-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow: hidden;
      min-height: 0;
    }

    /* === –ö–∞–ª–µ–Ω–¥–∞—Ä—å === */

    #calendarView { display: block; flex-shrink: 0; }

    .day-names {
      display: grid;
      grid-template-columns: repeat(7,minmax(0,1fr));
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .day-name {
      text-align: right;
      padding: 0 6px 4px;
    }

    .calendar-grid {
      position: relative;
      display: grid;
      grid-template-columns: repeat(7,minmax(0,1fr));
      grid-auto-rows: var(--calendar-row-height);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,0.35);
      background: radial-gradient(circle at top,#020617 0,#020617 100%);
    }

    .day-cell {
      border-right: 1px solid rgba(30,64,175,0.35);
      border-bottom: 1px solid rgba(30,64,175,0.35);
      padding: 4px 4px 2px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      position: relative;
      background: radial-gradient(circle at top left,#020617 0,#020617 100%);
      z-index: 1;
      cursor: pointer;
      transition:
        background 0.12s ease,
        box-shadow 0.12s ease,
        transform 0.08s ease;
    }

    .day-cell:nth-child(7n) { border-right: none; }
    .day-cell:nth-last-child(-n+7) { border-bottom: none; }
    .day-cell.is-outside { opacity: 0.45; }

    .day-cell.is-weekend {
      background: radial-gradient(circle at top, rgba(30,64,175,0.45), #020617 120%);
    }

    .day-cell:hover:not(.day-cell--selected) {
      background: radial-gradient(circle at top, rgba(148,163,184,0.24), #020617 120%);
      box-shadow: inset 0 0 0 1px rgba(148,163,184,0.55);
      transform: translateY(-0.5px);
    }

    .day-cell.is-weekend:hover:not(.day-cell--selected) {
      background: radial-gradient(circle at top, rgba(59,130,246,0.45), #020617 130%);
    }

    .day-cell--selected {
      background: rgba(148,163,184,0.3);
      box-shadow: 0 18px 50px rgba(15,23,42,0.9);
      outline: 1px dashed rgba(248,250,252,0.9);
      outline-offset: -1px;
      z-index: 3;
    }

    .day-number-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
    }
    .day-number { font-size: 11px; font-weight: 500; color: #e5e7eb; }
    .day-number.today {
      background: var(--accent);
      color: #0b1120;
      border-radius: 999px;
      padding: 1px 7px;
    }

    .day-meta { font-size: 10px; color: var(--text-muted); opacity: 0.7; }

    .day-events { display: flex; flex-direction: column; gap: 2px; margin-top: 2px; }

    .day-more-indicator {
      padding: 0 6px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.6);
      font-size: 9px;
      color: var(--text-muted);
      cursor: pointer;
      white-space: nowrap;
    }

    /* –û–≤–µ—Ä–ª–µ–π –ø–æ–ª–æ—Å –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
    .calendar-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 2;
    }

    .calendar-overlay-bar {
      position: absolute;
      height: 12px;
      border-radius: 999px;
      padding: 0 6px;
      font-size: 9px;
      color: #020617;
      display: flex;
      align-items: center;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      pointer-events: auto;
      transition: filter 0.08s ease;
    }

    .calendar-overlay-bar:hover { filter: brightness(0.75); }

    .disc-cs2      { background: var(--disc-cs2); }
    .disc-dota2    { background: var(--disc-dota2); }
    .disc-valorant { background: var(--disc-valorant); }
    .disc-efootball{ background: var(--disc-efootball); }
    .disc-lol      { background: var(--disc-lol); }
    .disc-football { background: var(--disc-football); }
    .disc-projectd { background: var(--disc-projectd); }
    .disc-other    { background: var(--disc-other); }

    /* –ü–æ–ø-–∞–ø –ø–æ –¥–Ω—é */
    .day-popup-overlay {
      position: fixed;
      inset: 0;
      z-index: 60;
    }
    .day-popup-backdrop { position: absolute; inset: 0; background: transparent; }

    .day-popup-card {
      position: absolute;
      background: rgba(15,23,42,0.98);
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.7);
      box-shadow: 0 22px 60px rgba(0,0,0,0.9);
      padding: 8px 10px;
      min-width: 260px;
      max-width: 340px;
      pointer-events: auto;
      font-size: 11px;
    }

    .day-popup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .day-popup-date { color: var(--text-main); }
    .day-popup-close {
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      padding: 0 4px;
    }

    .day-popup-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 260px;
      overflow: auto;
      margin-top: 2px;
    }

    .day-popup-item {
      display: flex;
      flex-direction: column;
      gap: 1px;
      padding: 4px 4px;
      border-radius: 8px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(31,41,55,0.9);
    }

    .day-popup-item--has-comment {
      border-color: rgba(96,165,250,0.9);
    }

    .day-popup-item-title { font-size: 11px; }
    .day-popup-item-meta  { font-size: 10px; color: var(--text-muted); }

    .day-popup-item-comment-hint {
      font-size: 9px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .day-popup-item-comment-hint::before {
      content: "üí¨";
      font-size: 9px;
    }

    .day-popup-pill {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      margin-right: 4px;
      flex-shrink: 0;
    }

    /* —Ç—É–ª—Ç–∏–ø –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –≤ –ø–æ–ø-–∞–ø–µ –¥–Ω—è */
    .day-popup-comment {
      position: absolute;
      max-width: 260px;
      background: rgba(15,23,42,0.98);
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.7);
      box-shadow: 0 18px 50px rgba(0,0,0,0.9);
      padding: 6px 8px;
      font-size: 10px;
      color: var(--text-main);
      pointer-events: none;
      opacity: 0;
      transform: translateY(-2px);
      transition: opacity 0.12s ease, transform 0.08s ease;
      z-index: 5;
      white-space: pre-wrap;
      line-height: 1.4;
    }
    .day-popup-comment--visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* === –ì–∞–Ω—Ç === */

    .gantt-view {
      margin-top: 10px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.7);
      flex: 1;
      min-height: 0;
      display: none;
      overflow: hidden;
    }

    .gantt-scroll { width: 100%; height: 100%; overflow: auto; }

    .gantt-table {
      min-width: max-content;
      min-height: 100%;
      --sidebar-width-current: var(--gantt-sidebar-width);
    }

    .gantt-header {
      display: grid;
      grid-template-columns: var(--sidebar-width-current) 1fr;
      position: sticky;
      top: 0;
      z-index: 4;
      background: rgba(15,23,42,0.97);
      border-bottom: 1px solid rgba(148,163,184,0.35);
    }

    .gantt-header-left {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 6px;
      border-right: 1px solid rgba(148,163,184,0.35);
      font-size: 11px;
      font-weight: 500;
      position: sticky;
      left: 0;
      z-index: 5;
      background: rgba(15,23,42,0.97);
    }

    .gantt-header-title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .gantt-toggle-btn {
      border: none;
      padding: 3px 5px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.6);
      color: var(--text-main);
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      transition: background 0.12s ease,border-color 0.12s ease,transform 0.15s ease;
    }
    .gantt-toggle-btn:hover {
      background: rgba(15,23,42,1);
      border-color: rgba(248,250,252,0.9);
    }

    .gantt-header-right {
      display: grid;
      padding: 3px 0 2px;
      font-size: 10px;
      color: var(--text-muted);
      background: rgba(15,23,42,0.96);
      backdrop-filter: blur(14px);
    }

    .gantt-header-day {
      text-align: center;
      width: var(--gantt-day-width);
    }
    .gantt-header-day-number { font-size: 11px; }
    .gantt-header-day-month  { font-size: 9px; text-transform: uppercase; opacity: .7; }

    .gantt-header-day.is-today .gantt-header-day-number {
      color: var(--accent);
      font-weight: 600;
    }

    .gantt-header-day.weekend { background: rgba(15,23,42,0.9); }

    .gantt-line {
      display: grid;
      grid-template-columns: var(--sidebar-width-current) 1fr;
      min-width: max-content;
      height: var(--gantt-row-height);
    }

    .gantt-line-left {
      position: sticky;
      left: 0;
      z-index: 3;
      background: rgba(15,23,42,0.97);
      border-right: 1px solid rgba(148,163,184,0.35);
      border-bottom: 1px solid rgba(15,23,42,0.9);
      display: flex;
      align-items: center;
      padding: 2px 8px;
      font-size: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .gantt-line-right {
      position: relative;
      border-bottom: 1px solid rgba(15,23,42,0.9);
      background:
        repeating-linear-gradient(
          to right,
          rgba(148,163,184,0.16) 0px,
          rgba(148,163,184,0.16) 1px,
          transparent 1px,
          transparent calc(var(--gantt-day-width))
        );
    }

    .gantt-weekend-stripe {
      position: absolute;
      top: 0;
      bottom: 0;
      width: var(--gantt-day-width);
      background: rgba(148,163,184,0.07);
      pointer-events: none;
    }

    .gantt-bar {
      position: absolute;
      top: 3px;
      bottom: 3px;
      border-radius: 999px;
      opacity: 0.97;
      display: flex;
      align-items: center;
      padding: 0 6px;
      font-size: 9px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #020617;
      transition: filter 0.08s ease;
    }
    .gantt-bar:hover { filter: brightness(0.75); }

    .gantt-table.gantt-sidebar-collapsed {
      --sidebar-width-current: var(--gantt-sidebar-width-collapsed);
    }
    .gantt-table.gantt-sidebar-collapsed .gantt-header-title,
    .gantt-table.gantt-sidebar-collapsed .gantt-line-left-text {
      display: none;
    }
    .gantt-table.gantt-sidebar-collapsed .gantt-toggle-btn { transform: rotate(180deg); }

    .gantt-tooltip {
      position: fixed;
      z-index: 9999;
      max-width: 260px;
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.6);
      pointer-events: none;
      opacity: 0;
      transform: translate(-50%,-120%);
      white-space: nowrap;
      transition: opacity 0.12s ease;
    }
    .gantt-tooltip--visible { opacity: 1; }
    .gantt-tooltip-title { font-weight: 500; margin-bottom: 2px; }
    .gantt-tooltip-dates { font-size: 10px; color: var(--text-muted); }

    /* === –ú–æ–¥–∞–ª–∫–∞ —Å–æ–±—ã—Ç–∏—è === */

    .event-modal { position: fixed; inset: 0; z-index: 80; display: none; }
    .event-modal--open { display: block; }

    .event-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15,23,42,0.85);
      backdrop-filter: blur(14px);
    }

    .event-modal-dialog {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      width: min(460px, 100% - 32px);
      background: radial-gradient(circle at top,#020617 0,#020617 100%);
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.7);
      box-shadow: 0 24px 70px rgba(0,0,0,0.85);
      padding: 14px 18px 14px;
      font-size: 13px;
    }

    .event-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .event-modal-title { font-weight: 600; font-size: 14px; }

    .event-modal-close {
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 18px;
      padding: 0 4px;
      line-height: 1;
    }

    .event-form-grid { display: flex; flex-direction: column; gap: 8px; }

    .event-field-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .event-input,
    .event-select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.45);
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      padding: 6px 10px;
      font-size: 12px;
      outline: none;
    }
    .event-input:focus,
    .event-select:focus { border-color: rgba(248,250,252,0.9); }

    .event-row-inline { display: flex; gap: 8px; }
    .event-row-inline > div { flex: 1; }

    .event-modal-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
    }

    .event-footer-right { display: flex; gap: 8px; }

    .btn-danger {
      border-color: rgba(248,113,113,0.8);
      color: #fecaca;
    }
    .btn-danger:hover {
      background: rgba(127,29,29,0.9);
      border-color: rgba(254,202,202,1);
    }

    .event-modal-error {
      margin-top: 6px;
      font-size: 11px;
      color: #fecaca;
      min-height: 14px;
      line-height: 1.4;
    }

    /* === –ú–æ–¥–∞–ª–∫–∞ –ª–æ–≥–∏–Ω–∞ === */

    .login-modal { position: fixed; inset: 0; z-index: 85; display: none; }
    .login-modal--open { display: block; }

    .login-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15,23,42,0.85);
      backdrop-filter: blur(14px);
    }

    .login-modal-dialog {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      width: min(360px, 100% - 32px);
      background: radial-gradient(circle at top,#020617 0,#020617 100%);
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.7);
      box-shadow: 0 24px 70px rgba(0,0,0,0.85);
      padding: 14px 18px 14px;
      font-size: 13px;
    }

    .login-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .login-modal-title { font-weight: 600; font-size: 14px; }

    .login-modal-close {
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 18px;
      padding: 0 4px;
      line-height: 1;
    }

    .login-form-grid { display: flex; flex-direction: column; gap: 8px; }

    .login-field-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .login-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.45);
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      padding: 6px 10px;
      font-size: 12px;
      outline: none;
    }
    .login-input:focus { border-color: rgba(248,250,252,0.9); }

    .login-modal-footer {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
    }

    .login-modal-error {
      margin-top: 6px;
      font-size: 11px;
      color: #fecaca;
      min-height: 14px;
      line-height: 1.4;
    }

    @media (max-width:900px){
      body { padding: 12px; }
    }
    @media (max-width:720px){
      .app-header { flex-direction: column; align-items: flex-start; }
      .calendar-header { flex-direction: column; align-items: flex-start; }
      .calendar-header-right { align-items: flex-start; }
      .discipline-legend { justify-content: flex-start; }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="app-header-left">
      <div><svg width="30" height="33" viewBox="0 0 120 134" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M15.7896 1.41331C8.75758 -2.62259 0 2.46622 0 10.5882V30.7282C0 34.5898 2.10049 38.1442 5.47915 39.9999L39.0112 58.4174C42.2015 60.1697 46.0675 60.1505 49.2404 58.3668L66.2388 48.8104C73.3863 44.792 73.4319 34.496 66.3201 30.4143L15.7896 1.41331Z" fill="#DBD8DE"></path>
<path d="M0.195481 123.411C0.19478 131.533 8.95192 136.622 15.9843 132.587L33.6671 122.44C37.0114 120.521 39.0455 116.927 38.9726 113.065L38.9726 75.5C38.9032 71.814 36.2082 68.0795 33.0323 66.2198L16.0695 56.2871C9.03786 52.1697 0.201193 57.2526 0.200489 65.4151L0.195481 123.411Z" fill="#DBD8DE"></path>
<path d="M114.692 75.9891C121.769 71.9289 121.77 61.6989 114.693 57.638L97.142 47.5672C93.8344 45.6692 89.7625 45.7073 86.4908 47.6668L53.6769 67.3197C50.5191 69.211 48.5725 72.6145 48.5398 76.3015L48.3676 95.7123C48.2952 103.875 57.087 109.037 64.1552 104.982L114.692 75.9891Z" fill="#DBD8DE"></path>
</svg></div>
      <div class="app-title">
        <div class="app-title-main">Tournament Calendar</div>
        <div class="app-title-sub">–ú–µ—Å—è—Ü + –ì–∞–Ω—Ç (–º–µ—Å—è—Ü/–≥–æ–¥) + —Ñ–∏–ª—å—Ç—Ä</div>
      </div>
    </div>
    <div class="app-header-right">
      <button class="btn" id="adminActionBtn">–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É</button>
    </div>
  </header>

  <section class="calendar-card">
    <div id="loadingOverlay" class="loading-overlay">
  <div class="loading-inner">
    <div class="loading-spinner"></div>
    <div class="loading-text">–ó–∞–≥—Ä—É–∂–∞—é —Ç—É—Ä–Ω–∏—Ä—ã‚Ä¶</div>
  </div>
</div>
    <div class="calendar-header">
      <div class="month-caption">
        <div class="month-name" id="monthLabel"></div>
        <div class="month-range" id="monthRange"></div>
      </div>
      <div class="calendar-header-right">
        <div class="nav-row">
          <div class="nav-buttons">
            <button class="btn btn-secondary" id="todayBtn">–°–µ–≥–æ–¥–Ω—è</button>
            <button class="btn" id="prevMonthBtn">
              <span class="btn-icon">‚Äπ</span>–ù–∞–∑–∞–¥
            </button>
            <button class="btn" id="nextMonthBtn">
              –í–ø–µ—Ä—ë–¥<span class="btn-icon">‚Ä∫</span>
            </button>
          </div>

          <div class="view-toggle">
            <button class="view-pill view-pill--active" id="viewCalendarBtn">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
            <button class="view-pill" id="viewGanttBtn">–ì–∞–Ω—Ç</button>
          </div>

          <div class="view-toggle gantt-range-toggle">
            <button class="view-pill view-pill--active" id="ganttRangeMonthBtn">–ú–µ—Å—è—Ü</button>
            <button class="view-pill" id="ganttRangeYearBtn">–ì–æ–¥</button>
          </div>

          <div class="zoom-controls">
            <span class="zoom-label">–ó—É–º</span>
            <button class="btn btn-secondary btn-icon-only" id="zoomOutBtn">‚àí</button>
            <button class="btn btn-secondary btn-icon-only" id="zoomInBtn">+</button>
          </div>
        </div>

        <div class="discipline-legend" id="disciplineFilter">
          <button class="legend-item" data-disc="all">
            <span class="legend-swatch legend-all"></span>–í—Å–µ
          </button>
          <button class="legend-item" data-disc="cs2">
            <span class="legend-swatch legend-cs2"></span>cs2
          </button>
          <button class="legend-item" data-disc="dota2">
            <span class="legend-swatch legend-dota2"></span>Dota2
          </button>
          <button class="legend-item" data-disc="valorant">
            <span class="legend-swatch legend-valorant"></span>valorant
          </button>
          <button class="legend-item" data-disc="efootball">
            <span class="legend-swatch legend-efootball"></span>eFootball
          </button>
          <button class="legend-item" data-disc="lol">
            <span class="legend-swatch legend-lol"></span>LoL
          </button>
          <button class="legend-item" data-disc="football">
            <span class="legend-swatch legend-football"></span>Football
          </button>
          <button class="legend-item" data-disc="projectd">
            <span class="legend-swatch legend-projectd"></span>Project D
          </button>
          <button class="legend-item" data-disc="other">
            <span class="legend-swatch legend-other"></span>Other
          </button>
        </div>
      </div>
    </div>

    <div class="calendar-main">
      <div id="calendarView">
        <div class="day-names">
          <div class="day-name">–ü–Ω</div>
          <div class="day-name">–í—Ç</div>
          <div class="day-name">–°—Ä</div>
          <div class="day-name">–ß—Ç</div>
          <div class="day-name">–ü—Ç</div>
          <div class="day-name">–°–±</div>
          <div class="day-name">–í—Å</div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>

      <div class="gantt-view" id="ganttView">
        <div class="gantt-scroll" id="ganttScroll">
          <div class="gantt-table" id="ganttTable">
            <div class="gantt-header">
              <div class="gantt-header-left">
                <button class="gantt-toggle-btn" id="ganttToggleSidebar">¬´</button>
                <span class="gantt-header-title">–°–æ–±—ã—Ç–∏—è</span>
              </div>
              <div class="gantt-header-right" id="ganttHeaderRow"></div>
            </div>
            <div class="gantt-body" id="ganttBody"></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ —Å–æ–±—ã—Ç–∏—è -->
<div class="event-modal" id="eventModal">
  <div class="event-modal-backdrop" id="eventModalBackdrop"></div>
  <div class="event-modal-dialog">
    <div class="event-modal-header">
      <div class="event-modal-title" id="eventModalTitle">–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ</div>
      <button class="event-modal-close" type="button" id="eventClose">√ó</button>
    </div>
    <form id="eventForm">
      <div class="event-form-grid">
        <div>
          <div class="event-field-label">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
          <input type="text" id="eventTitle" class="event-input" required />
        </div>

        <div>
          <div class="event-field-label">–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞</div>
          <select id="eventDiscipline" class="event-select">
            <option value="cs2">cs2</option>
            <option value="dota2">Dota2</option>
            <option value="valorant">valorant</option>
            <option value="efootball">eFootball</option>
            <option value="lol">LoL</option>
            <option value="football">Football</option>
            <option value="projectd">Project D</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="event-row-inline">
          <div>
            <div class="event-field-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</div>
            <input type="date" id="eventStart" class="event-input" required />
          </div>
          <div>
            <div class="event-field-label">–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞</div>
            <input type="date" id="eventEnd" class="event-input" required />
          </div>
        </div>

        <div>
          <div class="event-field-label">–õ–æ–∫–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</div>
          <input type="text" id="eventLocation" class="event-input" />
        </div>

        <div>
          <div class="event-field-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</div>
          <input type="text" id="eventComment" class="event-input" />
        </div>
      </div>

      <div class="event-modal-footer">
        <button type="button" class="btn btn-danger" id="eventDelete">–£–¥–∞–ª–∏—Ç—å</button>
        <div class="event-footer-right">
          <button type="button" class="btn btn-secondary" id="eventCancel">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn" id="eventSave">–ì–æ—Ç–æ–≤–æ</button>
        </div>
      </div>

      <div class="event-modal-error" id="eventModalError"></div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –ª–æ–≥–∏–Ω–∞ -->
<div class="login-modal" id="loginModal">
  <div class="login-modal-backdrop" id="loginModalBackdrop"></div>
  <div class="login-modal-dialog">
    <div class="login-modal-header">
      <div class="login-modal-title">–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É</div>
      <button class="login-modal-close" type="button" id="loginClose">√ó</button>
    </div>
    <form id="loginForm">
      <div class="login-form-grid">
        <div>
          <div class="login-field-label">–õ–æ–≥–∏–Ω</div>
          <input type="text" id="loginUsername" class="login-input" autocomplete="username" />
        </div>
        <div>
          <div class="login-field-label">–ü–∞—Ä–æ–ª—å</div>
          <input type="password" id="loginPassword" class="login-input" autocomplete="current-password" />
        </div>
      </div>

      <div class="login-modal-footer">
        <button type="button" class="btn btn-secondary" id="loginCancel">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="btn" id="loginSubmit">–í–æ–π—Ç–∏</button>
      </div>

      <div class="login-modal-error" id="loginModalError"></div>
    </form>
  </div>
</div>

<script>
  // URL, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–¥–∞—ë—Ç JSON —Å–æ —Å–ø–∏—Å–∫–æ–º —Å–æ–±—ã—Ç–∏–π (echo)
const EVENTS_URL = "https://event-calendar-api.valkirvideo.workers.dev/events";

// URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Apps Script (—Ç–æ—Ç —Å–∞–º—ã–π /exec)
const API_URL = "https://event-calendar-api.valkirvideo.workers.dev/api";


  let eventsFromTable = [];

  const loadingOverlayEl = document.getElementById("loadingOverlay");
  function setLoading(isLoading) {
    if (!loadingOverlayEl) return;
    loadingOverlayEl.classList.toggle("loading-overlay--hidden", !isLoading);
  }

  const monthNamesRu = [
    "–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å",
    "–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"
  ];
  function dateToIsoLocal(date){
    const y = date.getFullYear();
    const m = String(date.getMonth()+1).padStart(2,"0");
    const d = String(date.getDate()).padStart(2,"0");
    return `${y}-${m}-${d}`;
  }
  function parseISODate(str){const [y,m,d]=str.split("-").map(Number);return new Date(y,m-1,d);}
  function sameDate(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();}
  function getMonday(d){const r=new Date(d);const day=r.getDay();const diff=(day+6)%7;r.setDate(r.getDate()-diff);return r;}
  function addDays(date,days){const d=new Date(date);d.setDate(d.getDate()+days);return d;}

  function formatRuRange(start,end){
    const sameMonth=start.getMonth()===end.getMonth()&&start.getFullYear()===end.getFullYear();
    if(sameMonth){
      return `${start.toLocaleDateString("ru-RU",{day:"numeric"})}‚Äì${end.toLocaleDateString("ru-RU",{day:"numeric",month:"short"})}`;
    }
    return `${start.toLocaleDateString("ru-RU",{day:"numeric",month:"short"})} ‚Äì ${end.toLocaleDateString("ru-RU",{day:"numeric",month:"short"})}`;
  }

  function normalizeDiscipline(disc){
    const s=(disc||"").toLowerCase().replace(/\s+/g,"");
    if(s.includes("cs2")||s==="cs"||s==="csgo") return "cs2";
    if(s.includes("dota")) return "dota2";
    if(s.includes("valorant")) return "valorant";
    if(s.includes("efc")||s.includes("efootball")||s.includes("fifa")||s.includes("eafc")||s.includes("fc")) return "efootball";
    if(s==="lol"||s.includes("leagueoflegends")) return "lol";
    if(s==="football"||s==="soccer") return "football";
    if(s.includes("projectd")) return "projectd";
    return "other";
  }

  function disciplineToClassName(disc){
    const key=normalizeDiscipline(disc);
    if(key==="cs2") return "disc-cs2";
    if(key==="dota2") return "disc-dota2";
    if(key==="valorant") return "disc-valorant";
    if(key==="efootball") return "disc-efootball";
    if(key==="lol") return "disc-lol";
    if(key==="football") return "disc-football";
    if(key==="projectd") return "disc-projectd";
    return "disc-other";
  }

  const EVENTS_CACHE_KEY = "calendarEventsCache_v1";
const EVENTS_CACHE_TTL_MS = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

function loadEventsFromCache() {
  try {
    const raw = localStorage.getItem(EVENTS_CACHE_KEY);
    if (!raw) return false;
    const { ts, events } = JSON.parse(raw);
    if (!Array.isArray(events)) return false;
    if (Date.now() - ts > EVENTS_CACHE_TTL_MS) return false;

    eventsFromTable = events;
    renderCalendar();
    return true;
  } catch (e) {
    console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫—ç—à —Å–æ–±—ã—Ç–∏–π:", e);
    return false;
  }
}

function saveEventsToCache(events) {
  try {
    localStorage.setItem(
      EVENTS_CACHE_KEY,
      JSON.stringify({ ts: Date.now(), events })
    );
  } catch (e) {
    console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫—ç—à —Å–æ–±—ã—Ç–∏–π:", e);
  }
}


  // === –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π —Å –±—ç–∫–∞ (GET, –ø—É–±–ª–∏—á–Ω–æ) ===
// === –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π —Å –±—ç–∫–∞ (GET, –ø—É–±–ª–∏—á–Ω–æ) ===
async function loadEventsFromSheet() {
  setLoading(true);
  try {
    const urlObj = new URL(EVENTS_URL);

    // –ß—Ç–æ–±—ã –∫—ç—à –Ω–µ –º–µ—à–∞–ª
    urlObj.searchParams.set("t", Date.now().toString());

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω (admin –∏–ª–∏ client) ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º token.
    if (authToken) {
      urlObj.searchParams.set("token", authToken);
    }

    const res = await fetch(urlObj.toString(), { method: "GET" });
    const text = await res.text();

    let data;
    try {
      data = JSON.parse(text);
    } catch (err) {
      console.error("–û—Ç–≤–µ—Ç –Ω–µ JSON, –ø—Ä–∏—à—ë–ª HTML/–æ—à–∏–±–∫–∞:", err);
      console.error(text.slice(0, 300));
      return;
    }

    if (!data || !data.ok || !Array.isArray(data.events)) {
      console.error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç:", data);
      return;
    }

    eventsFromTable = data.events.map(ev => ({
      rowIndex:   ev.rowIndex,
      title:      ev.title || "",
      discipline: ev.discipline || "",
      startDate:  ev.startDate,
      endDate:    ev.endDate,
      location:   ev.location || "",
      comment:    ev.comment || ""
    }));

    renderCalendar();
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π:", e);
  } finally {
    setLoading(false);
  }
}

  const today = new Date();
  let currentYear  = today.getFullYear();
  let currentMonth = today.getMonth();
  let currentView  = "calendar";

  const allDisciplineKeys = ["cs2","dota2","valorant","efootball","lol","football","projectd","other"];

const projectDLegendBtn = document.querySelector('#disciplineFilter [data-disc="projectd"]');

// –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ Project D (–∞–¥–º–∏–Ω –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç)
function updateProjectDVisibility() {
  if (!projectDLegendBtn) return;

  const canSeeProjectD = isAdmin || isClient;

  if (canSeeProjectD) {
    projectDLegendBtn.style.display = "inline-flex";
    activeDisciplines.add("projectd");
  } else {
    projectDLegendBtn.style.display = "none";
    activeDisciplines.delete("projectd");
  }

  // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º –¥–∏—Å—Ü–∏–ø–ª–∏–Ω
  renderCalendar();
}

let activeDisciplines = new Set(allDisciplineKeys);

  let ganttRangeMode = "month";
  let ganttDayWidth  = 26;
  const MIN_GANTT_DAY_WIDTH = 8;
  const MIN_GANTT_DAY_WIDTH_MONTH_HARD = 10;
  let currentGanttDaysCount = 0;
  let calendarBaseRowHeight = 88;

  const monthLabelEl  = document.getElementById("monthLabel");
  const monthRangeEl  = document.getElementById("monthRange");
  const calendarGridEl= document.getElementById("calendarGrid");
  const calendarViewEl= document.getElementById("calendarView");
  const ganttViewEl   = document.getElementById("ganttView");
  const ganttHeaderRowEl = document.getElementById("ganttHeaderRow");
  const ganttBodyEl   = document.getElementById("ganttBody");
  const ganttScrollEl = document.getElementById("ganttScroll");
  const ganttTableEl  = document.getElementById("ganttTable");
  const ganttToggleSidebarBtn = document.getElementById("ganttToggleSidebar");

  const prevMonthBtn  = document.getElementById("prevMonthBtn");
  const nextMonthBtn  = document.getElementById("nextMonthBtn");
  const zoomControlsEl = document.querySelector(".zoom-controls");
  const adminActionBtn = document.getElementById("adminActionBtn");
  const zoomInBtn  = document.getElementById("zoomInBtn");
  const zoomOutBtn = document.getElementById("zoomOutBtn");

  const eventModalErrorEl = document.getElementById("eventModalError");
  function setEventModalError(message) {
    if (!eventModalErrorEl) return;
    eventModalErrorEl.textContent = message || "";
  }

  const ganttTooltip = document.createElement("div");
  ganttTooltip.className = "gantt-tooltip";
  document.body.appendChild(ganttTooltip);

  function showTooltip(title, dates, x, y){
    ganttTooltip.innerHTML =
      `<div class="gantt-tooltip-title">${title}</div>`+
      `<div class="gantt-tooltip-dates">${dates}</div>`;
    moveTooltip(x,y);
    ganttTooltip.classList.add("gantt-tooltip--visible");
  }
  function moveTooltip(x,y){
    ganttTooltip.style.left = `${x}px`;
    ganttTooltip.style.top  = `${y-12}px`;
  }
  function hideTooltip(){
    ganttTooltip.classList.remove("gantt-tooltip--visible");
  }
  function formatTooltipDate(iso){
    const d=parseISODate(iso);
    return d.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric"});
  }
  function applyGanttDayWidth(){
    document.documentElement.style.setProperty("--gantt-day-width", ganttDayWidth + "px");
  }

  // === –ú–æ–¥–∞–ª–∫–∞ —Å–æ–±—ã—Ç–∏—è ===
  const eventModalEl        = document.getElementById("eventModal");
  const eventModalBackdrop  = document.getElementById("eventModalBackdrop");
  const eventModalTitleEl   = document.getElementById("eventModalTitle");
  const eventForm           = document.getElementById("eventForm");
  const eventTitleInput     = document.getElementById("eventTitle");
  const eventDisciplineSel  = document.getElementById("eventDiscipline");
  const eventStartInput     = document.getElementById("eventStart");
  const eventEndInput       = document.getElementById("eventEnd");
  const eventLocationInput  = document.getElementById("eventLocation");
  const eventCommentInput   = document.getElementById("eventComment");
  const eventDeleteBtn      = document.getElementById("eventDelete");
  const eventCancelBtn      = document.getElementById("eventCancel");
  const eventCloseBtn       = document.getElementById("eventClose");
  const eventSaveBtn        = document.getElementById("eventSave");

  let editingEvent = null;
  let currentEventMode = "create";

  function openEventModal(mode, eventObj) {
    currentEventMode = mode;
    editingEvent = eventObj || null;
    setEventModalError("");

    if (mode === "edit" && editingEvent) {
      eventModalTitleEl.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è";
      eventTitleInput.value    = editingEvent.title || "";
      eventDisciplineSel.value = normalizeDiscipline(editingEvent.discipline || "other");
      eventStartInput.value    = editingEvent.startDate || "";
      eventEndInput.value      = editingEvent.endDate || "";
      eventLocationInput.value = editingEvent.location || "";
      eventCommentInput.value  = editingEvent.comment || "";
      eventDeleteBtn.style.display = "inline-flex";
    } else {
      eventModalTitleEl.textContent = "–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ";
      eventTitleInput.value    = "";
      eventDisciplineSel.value = "cs2";
      const todayISO = new Date().toISOString().slice(0,10);
      eventStartInput.value    = todayISO;
      eventEndInput.value      = todayISO;
      eventLocationInput.value = "";
      eventCommentInput.value  = "";
      eventDeleteBtn.style.display = "none";
    }

    eventModalEl.classList.add("event-modal--open");
  }

  function closeEventModal() {
    eventModalEl.classList.remove("event-modal--open");
    setEventModalError("");
    editingEvent = null;
    currentEventMode = "create";
  }

  eventCancelBtn.addEventListener("click", closeEventModal);
  eventCloseBtn.addEventListener("click", closeEventModal);
  eventModalBackdrop.addEventListener("click", closeEventModal);

  // === –ú–æ–¥–∞–ª–∫–∞ –ª–æ–≥–∏–Ω–∞ ===
  const loginModalEl       = document.getElementById("loginModal");
  const loginModalBackdrop = document.getElementById("loginModalBackdrop");
  const loginCloseBtn      = document.getElementById("loginClose");
  const loginCancelBtn     = document.getElementById("loginCancel");
  const loginFormEl        = document.getElementById("loginForm");
  const loginUsernameInput = document.getElementById("loginUsername");
  const loginPasswordInput = document.getElementById("loginPassword");
  const loginSubmitBtn     = document.getElementById("loginSubmit");
  const loginErrorEl       = document.getElementById("loginModalError");

  function setLoginError(msg) {
    loginErrorEl.textContent = msg || "";
  }

  function openLoginModal(initialError) {
    if (initialError) setLoginError(initialError); else setLoginError("");
    loginModalEl.classList.add("login-modal--open");
    loginUsernameInput.focus();
  }

  function closeLoginModal() {
    loginModalEl.classList.remove("login-modal--open");
    setLoginError("");
    loginPasswordInput.value = "";
  }

  loginModalBackdrop.addEventListener("click", closeLoginModal);
  loginCloseBtn.addEventListener("click", closeLoginModal);
  loginCancelBtn.addEventListener("click", closeLoginModal);

  // === –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ ===
let authToken = localStorage.getItem("calendarAuthToken") || null;
let userRole  = localStorage.getItem("calendarUserRole") || null; // 'admin' / 'client' / null
let isAdmin   = (userRole === "admin");
let isClient  = (userRole === "client");

updateAdminUI(); // –≤–Ω—É—Ç—Ä–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∏ –≤–∏–¥–∏–º–æ—Å—Ç—å Project D

function updateAdminUI() {
  if (!adminActionBtn) return;

  if (userRole === "admin") {
    adminActionBtn.textContent = "–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ";
  } else if (userRole === "client") {
    adminActionBtn.textContent = "Project D (—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä)";
  } else {
    adminActionBtn.textContent = "–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É";
  }

  // –∑–¥–µ—Å—å –∂–µ –ø—Ä—è—á–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É Project D
  updateProjectDVisibility();
}

  function handleUnauthorized() {
  authToken = null;
  userRole  = null;
  isAdmin   = false;
  isClient  = false;
  localStorage.removeItem("calendarAuthToken");
  localStorage.removeItem("calendarUserRole");
  updateAdminUI(); // –≤–Ω—É—Ç—Ä–∏ —Å–ø—Ä—è—á–µ—Ç—Å—è Project D
  openLoginModal("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.");
}

  async function performLogin(login, password) {
  const payload = {
    action: "login",
    login,
    password
  };

  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify(payload)
  });

  const text = await res.text();
  let data;
  try {
    data = JSON.parse(text);
  } catch (err) {
    throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ (–Ω–µ JSON).");
  }
  return data;
}

  loginFormEl.addEventListener("submit", async (e) => {
    e.preventDefault();
    setLoginError("");

    const login = loginUsernameInput.value.trim();
    const password = loginPasswordInput.value.trim();

    if (!login || !password) {
      setLoginError("–í–≤–µ–¥–∏ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.");
      return;
    }

    loginSubmitBtn.disabled = true;
    try {
      const data = await performLogin(login, password);
    if (!data.ok) {
      setLoginError(data.error || "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å.");
      return;
    }
    authToken = data.token;
userRole  = data.role || "admin"; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é admin, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫
isAdmin   = (userRole === "admin");
isClient  = (userRole === "client");

localStorage.setItem("calendarAuthToken", authToken);
localStorage.setItem("calendarUserRole",  userRole);

updateAdminUI(); // –ø–æ–∫–∞–∂–µ—Ç Project D, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
closeLoginModal();

// –ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è, —á—Ç–æ–±—ã –ø–æ—è–≤–∏–ª–∏—Å—å Project D
loadEventsFromSheet();

    } catch (err) {
      setLoginError("–û—à–∏–±–∫–∞: " + err.message);
    } finally {
      loginSubmitBtn.disabled = false;
    }
  });

  adminActionBtn.addEventListener("click", () => {
  if (!isAdmin && !isClient) {
    // –≥–æ—Å—Ç—å -> –ª–æ–≥–∏–Ω
    openLoginModal();
  } else if (isAdmin) {
    // –∞–¥–º–∏–Ω -> —Å–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ
    openEventModal("create");
  } else {
    // client: —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä Project D, –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º
  }
});

  // === –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π —Å –±—ç–∫–æ–º (create/update/delete, —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞) ===
  async function syncEventWithSheet(payloadBase) {
  const payload = Object.assign({}, payloadBase, {
    token: authToken || undefined
  });

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch (err) {
      return { ok: false, error: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–µ JSON)" };
    }

    if (!data.ok && data.error === "UNAUTHORIZED") {
      handleUnauthorized();
    }

    return data;
  } catch (err) {
    return {
      ok: false,
      error: "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + (err && err.message ? err.message : String(err))
    };
  }
}

  function collectFormEventData(){
    return {
      title: eventTitleInput.value.trim(),
      discipline: eventDisciplineSel.value,
      startDate: eventStartInput.value,
      endDate: eventEndInput.value,
      location: eventLocationInput.value.trim(),
      comment: eventCommentInput.value.trim(),
      rowIndex: editingEvent && editingEvent.rowIndex ? editingEvent.rowIndex : null
    };
  }

  eventForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    setEventModalError("");

    const ev = collectFormEventData();
    if(!ev.title || !ev.startDate || !ev.endDate){
      setEventModalError("–ó–∞–ø–æ–ª–Ω–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–±–µ –¥–∞—Ç—ã.");
      return;
    }

    const action = (currentEventMode === "edit" && ev.rowIndex) ? "update" : "create";
    if (eventSaveBtn) eventSaveBtn.disabled = true;

    const payload = {
      action,
      event: ev,
      rowIndex: action === "update" ? ev.rowIndex : undefined
    };

    const res = await syncEventWithSheet(payload);

    if (!res.ok) {
      setEventModalError(res.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.");
      if (eventSaveBtn) eventSaveBtn.disabled = false;
      return;
    }

    await loadEventsFromSheet();
    closeEventModal();
    if (eventSaveBtn) eventSaveBtn.disabled = false;
  });

  eventDeleteBtn.addEventListener("click", async ()=>{
    if(!editingEvent || !editingEvent.rowIndex){
      closeEventModal();
      return;
    }
    if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ?")) return;

    setEventModalError("");
    const res = await syncEventWithSheet({
      action: "delete",
      rowIndex: editingEvent.rowIndex
    });

    if (!res.ok) {
      setEventModalError(res.error || "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ.");
      return;
    }

    await loadEventsFromSheet();
    closeEventModal();
  });

  let dayPopupOverlay = null;
  let lastSelectedCell = null;

  function closeDayPopup(){
    if(dayPopupOverlay){
      dayPopupOverlay.remove();
      dayPopupOverlay = null;
    }
    if(lastSelectedCell){
      lastSelectedCell.classList.remove("day-cell--selected");
      lastSelectedCell = null;
    }
  }

  function showDayCommentTooltip(ev, itemEl, cardEl, tooltipEl) {
    if (!ev.comment || !ev.comment.trim()) return;
    tooltipEl.textContent = ev.comment;
    tooltipEl.classList.add("day-popup-comment--visible");

    const itemRect = itemEl.getBoundingClientRect();
    const cardRect = cardEl.getBoundingClientRect();
    const gap = 8;

    let relTop = itemRect.top - cardRect.top;
    let relLeft = cardRect.width + gap;

    tooltipEl.style.left = relLeft + "px";
    tooltipEl.style.top  = relTop + "px";

    requestAnimationFrame(() => {
      const ttRect = tooltipEl.getBoundingClientRect();
      let left = relLeft;
      let top  = relTop;

      if (ttRect.right > window.innerWidth - 12) {
        left = -ttRect.width - gap;
      }

      if (ttRect.bottom > window.innerHeight - 12) {
        const overflow = ttRect.bottom - (window.innerHeight - 12);
        top = Math.max(0, relTop - overflow);
      }

      tooltipEl.style.left = left + "px";
      tooltipEl.style.top  = top + "px";
    });
  }

  function hideDayCommentTooltip(tooltipEl) {
    tooltipEl.classList.remove("day-popup-comment--visible");
  }

  function openDayPopup(cell,date,events){
    closeDayPopup();
    if(!events || !events.length) return;

    lastSelectedCell = cell;
    cell.classList.add("day-cell--selected");

    const overlay = document.createElement("div");
    overlay.className = "day-popup-overlay";

    const backdrop = document.createElement("div");
    backdrop.className = "day-popup-backdrop";
    overlay.appendChild(backdrop);

    const card = document.createElement("div");
    card.className = "day-popup-card";

    const dateLabel = date.toLocaleDateString("ru-RU",{
      day:"numeric",
      month:"long",
      year:"numeric"
    });

    card.innerHTML = `
      <div class="day-popup-header">
        <div class="day-popup-date">${dateLabel}</div>
        <button class="day-popup-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      </div>
      <div class="day-popup-list"></div>
    `;

    const list = card.querySelector(".day-popup-list");

    const commentTooltip = document.createElement("div");
    commentTooltip.className = "day-popup-comment";
    card.appendChild(commentTooltip);

    events.forEach(ev=>{
      const item = document.createElement("div");
      item.className = "day-popup-item";

      const headerRow = document.createElement("div");
      headerRow.style.display="flex";
      headerRow.style.alignItems="center";

      const pill = document.createElement("div");
      pill.className = "day-popup-pill " + disciplineToClassName(ev.discipline);

      const title = document.createElement("div");
      title.className = "day-popup-item-title";
      title.textContent = ev.title;

      headerRow.appendChild(pill);
      headerRow.appendChild(title);

      const meta = document.createElement("div");
      meta.className = "day-popup-item-meta";
      const s = formatTooltipDate(ev.startDate);
      const en= formatTooltipDate(ev.endDate);
      meta.textContent = `${ev.discipline} ‚Ä¢ ${s} ‚Äî ${en}`;

      item.appendChild(headerRow);
      item.appendChild(meta);

      if (ev.comment && ev.comment.trim()) {
        item.classList.add("day-popup-item--has-comment");
        const hint = document.createElement("div");
        hint.className = "day-popup-item-comment-hint";
        hint.textContent = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π";
        item.appendChild(hint);

        item.addEventListener("mouseenter", () =>
          showDayCommentTooltip(ev, item, card, commentTooltip)
        );
        item.addEventListener("mouseleave", () =>
          hideDayCommentTooltip(commentTooltip)
        );
      }

      list.appendChild(item);
    });

    overlay.appendChild(card);
    document.body.appendChild(overlay);
    dayPopupOverlay = overlay;

    const rect = cell.getBoundingClientRect();
    card.style.left = "0px";
    card.style.top  = "0px";

    requestAnimationFrame(()=>{
      const cRect = card.getBoundingClientRect();
      let left = rect.left;
      if(left + cRect.width > window.innerWidth - 16){
        left = window.innerWidth - cRect.width - 16;
      }
      if(left < 16) left = 16;

      let top = rect.bottom + 8;
      if(top + cRect.height > window.innerHeight - 16){
        top = rect.top - cRect.height - 8;
      }
      if(top < 16) top = 16;

      card.style.left = `${left}px`;
      card.style.top  = `${top}px`;
    });

    backdrop.addEventListener("click", closeDayPopup);
    card.querySelector(".day-popup-close").addEventListener("click", closeDayPopup);
  }

  function renderCalendar(){
    updateViewVisibility();

    const firstOfMonth = new Date(currentYear,currentMonth,1);
    const lastOfMonth  = new Date(currentYear,currentMonth+1,0);

    let headerTitle = `${monthNamesRu[currentMonth]} ${currentYear}`;
    let headerRange = formatRuRange(firstOfMonth,lastOfMonth);

    if(currentView==="gantt" && ganttRangeMode==="year"){
      headerTitle = `${currentYear}`;
      headerRange = "";
    }

    monthLabelEl.textContent = headerTitle;
    monthRangeEl.textContent = headerRange;

    const gridStart = getMonday(firstOfMonth);
    const gridDates = [];
    const dayCells  = [];
    calendarGridEl.innerHTML = "";

    for(let i=0;i<42;i++){
      const date = addDays(gridStart,i);
      gridDates.push(date);

      const cell = document.createElement("div");
      cell.className = "day-cell";
      if(date.getMonth()!==currentMonth) cell.classList.add("is-outside");

      const dow = date.getDay();
      if(dow===0 || dow===6) cell.classList.add("is-weekend");

      const dayNumberRow = document.createElement("div");
      dayNumberRow.className = "day-number-row";

      const dayNumber = document.createElement("div");
      dayNumber.className = "day-number";
      dayNumber.textContent = String(date.getDate());
      if(sameDate(date,today)) dayNumber.classList.add("today");

      const meta = document.createElement("div");
      meta.className = "day-meta";

      dayNumberRow.appendChild(dayNumber);
      dayNumberRow.appendChild(meta);

      const eventsContainer = document.createElement("div");
      eventsContainer.className = "day-events";

      cell.appendChild(dayNumberRow);
      cell.appendChild(eventsContainer);
      calendarGridEl.appendChild(cell);
      dayCells.push(cell);
    }

    adjustCalendarRowHeightDynamic();
    renderEventsOnCalendar(gridDates,dayCells);

    applyGanttDayWidth();
    const firstForGantt = new Date(currentYear,currentMonth,1);
    const lastForGantt  = new Date(currentYear,currentMonth+1,0);
    renderGantt(firstForGantt,lastForGantt);

    updateDisciplineFilterButtons();
    updateGanttRangeControls();
    updateNavButtonsVisibility();
  }

  function renderEventsOnCalendar(gridDates, dayCells) {
    const gridStart = gridDates[0];
    const gridEnd   = gridDates[gridDates.length - 1];

    let overlayEl = calendarGridEl.querySelector(".calendar-overlay");
    if (!overlayEl) {
      overlayEl = document.createElement("div");
      overlayEl.className = "calendar-overlay";
      calendarGridEl.appendChild(overlayEl);
    }
    overlayEl.innerHTML = "";

    const dateIndexMap = new Map();
    gridDates.forEach((date, idx) => {
      const week = Math.floor(idx / 7);
      const col  = idx % 7;
      const key = date.toISOString().slice(0,10);
      dateIndexMap.set(key,{ index:idx, week, col, date });
    });

    const dayEventsMap   = new Map();
    const weekBuckets    = new Map();

    const visibleEvents = eventsFromTable.filter(ev => {
      const key = normalizeDiscipline(ev.discipline);
      if (!activeDisciplines.has(key)) return false;
      const start = parseISODate(ev.startDate);
      const end   = parseISODate(ev.endDate);
      return !(end < gridStart || start > gridEnd);
    });

    visibleEvents.forEach(ev => {
      const start = parseISODate(ev.startDate);
      const end   = parseISODate(ev.endDate);

      const visibleStart = start < gridStart ? gridStart : start;
      const visibleEnd   = end   > gridEnd   ? gridEnd   : end;

      const weekMap = new Map();

      for (let d = new Date(visibleStart); d <= visibleEnd; d = addDays(d,1)) {
        const key = d.toISOString().slice(0,10);
        const info = dateIndexMap.get(key);
        if (!info) continue;

        let list = dayEventsMap.get(key);
        if (!list) {
          list = [];
          dayEventsMap.set(key,list);
        }
        list.push(ev);

        let arr = weekMap.get(info.week);
        if (!arr) {
          arr = [];
          weekMap.set(info.week,arr);
        }
        arr.push(info);
      }

      weekMap.forEach((infos, week) => {
        infos.sort((a,b)=>a.col - b.col);
        const startCol = infos[0].col;
        const endCol   = infos[infos.length-1].col;

        let bucket = weekBuckets.get(week);
        if (!bucket) {
          bucket = [];
          weekBuckets.set(week,bucket);
        }
        bucket.push({ event: ev, startCol, endCol, infos });
      });
    });

    const visibleEventsMap = new Map();

    if (!dayCells.length) return;
    const sampleRect = dayCells[0].getBoundingClientRect();
    const cellWidth  = sampleRect.width;
    const cellHeight = sampleRect.height;

    const BASE_CELL_HEIGHT = calendarBaseRowHeight;
    const factor = Math.max(1, cellHeight / BASE_CELL_HEIGHT);

    const baseOffset = 24;
    const slotHeight = Math.floor(14 * factor);
    const barHeight  = Math.floor(12 * factor);
    
    const horizontalPadding = 4;
    const MAX_SLOTS_PER_WEEK = 4;

    weekBuckets.forEach((weekEvents, week) => {
      weekEvents.sort((a,b)=>a.startCol - b.startCol || a.endCol - b.endCol);
      const rows = [];

      weekEvents.forEach(we => {
        let slot = -1;
        for (let i=0;i<rows.length;i++){
          if (we.startCol > rows[i]) {
            slot = i;
            rows[i] = we.endCol;
            break;
          }
        }
        if (slot === -1) {
          if (rows.length < MAX_SLOTS_PER_WEEK) {
            slot = rows.length;
            rows.push(we.endCol);
          } else {
            slot = null;
          }
        }
        we.slot = slot;
      });

      weekEvents.forEach(we => {
        const ev = we.event;
        if (we.slot === null) return;

        const spanCols = we.endCol - we.startCol + 1;
        const left = we.startCol * cellWidth + horizontalPadding;
        const top  = week * cellHeight + baseOffset + we.slot * slotHeight;
        const width = spanCols * cellWidth - 2 * horizontalPadding;

        const discClass = disciplineToClassName(ev.discipline);
        const bar = document.createElement("div");
        bar.className = `calendar-overlay-bar ${discClass}`;
        bar.style.left  = `${left}px`;
        bar.style.top   = `${top}px`;
        bar.style.width = `${Math.max(8,width)}px`;
        bar.style.height= `${barHeight}px`;
        bar.dataset.start = ev.startDate;
        bar.dataset.end   = ev.endDate;
        bar.dataset.title = ev.title;

        bar.textContent   = `${ev.discipline}: ${ev.title}`;

        bar.addEventListener("mouseenter",e=>{
          const s = formatTooltipDate(bar.dataset.start);
          const en= formatTooltipDate(bar.dataset.end);
          const dates = `${s} ‚Äî ${en}`;
          showTooltip(bar.dataset.title,dates,e.clientX,e.clientY);
        });
        bar.addEventListener("mousemove",e=>moveTooltip(e.clientX,e.clientY));
        bar.addEventListener("mouseleave",hideTooltip);

        bar.addEventListener("contextmenu",e=>{
          if (!isAdmin) return;
          e.preventDefault();
          openEventModal("edit", ev);
        });

        overlayEl.appendChild(bar);

        we.infos.forEach(info => {
          const key = info.date.toISOString().slice(0,10);
          let set = visibleEventsMap.get(key);
          if (!set) {
            set = new Set();
            visibleEventsMap.set(key,set);
          }
          set.add(ev);
        });
      });
    });

    dayCells.forEach(cell => {
      cell.classList.remove("day-cell--selected");
      const more = cell.querySelector(".day-more-indicator");
      if (more) more.remove();
    });

    for (let i=0;i<dayCells.length;i++){
      const cell = dayCells[i];
      const date = gridDates[i];
      const key  = date.toISOString().slice(0,10);

      const eventsForDay = dayEventsMap.get(key) || [];
      const visibleSet   = visibleEventsMap.get(key) || new Set();
      const hiddenCount  = Math.max(0, eventsForDay.length - visibleSet.size);

      if (hiddenCount > 0){
        const more = document.createElement("div");
        more.className = "day-more-indicator";
        more.textContent = `+ –µ—â—ë ${hiddenCount}`;

        const headerRow = cell.querySelector(".day-number-row");
        if (headerRow) headerRow.appendChild(more);
        else cell.appendChild(more);
      }

      cell.onclick = () => {
        if (!eventsForDay.length) {
          closeDayPopup();
          return;
        }
        openDayPopup(cell,date,eventsForDay);
      };
    }
  }

  function renderGantt(firstOfMonth, lastOfMonth){
    ganttHeaderRowEl.innerHTML = "";
    ganttBodyEl.innerHTML = "";

    let rangeStart, rangeEnd;
    if (ganttRangeMode === "year") {
      rangeStart = new Date(currentYear, 0, 1);
      rangeEnd   = new Date(currentYear, 11, 31);
    } else {
      rangeStart = firstOfMonth;
      rangeEnd   = lastOfMonth;
    }

    const ganttDays = [];
    const ganttDayIsos = [];
    for (let d = new Date(rangeStart); d <= rangeEnd; d = addDays(d, 1)) {
      const copy = new Date(d);
      ganttDays.push(copy);
      ganttDayIsos.push(dateToIsoLocal(copy));
    }

    const daysCount = ganttDays.length;
    currentGanttDaysCount = daysCount;

    const totalWidth = daysCount * ganttDayWidth;
    const templateCols = `repeat(${daysCount}, var(--gantt-day-width))`;
    ganttHeaderRowEl.style.gridTemplateColumns = templateCols;

    const isYearMode = ganttRangeMode === "year";
    const showDenseDays = isYearMode && ganttDayWidth >= 22;

    const weekendIndices = [];
    ganttDays.forEach((d, idx) => {
      const dow = d.getDay();
      if (dow === 0 || dow === 6) weekendIndices.push(idx);
    });

    ganttDays.forEach((d) => {
      const dayEl = document.createElement("div");
      dayEl.className = "gantt-header-day";
      if (sameDate(d, today)) dayEl.classList.add("is-today");

      const dow = d.getDay();
      if ((dow === 0 || dow === 6) && (!isYearMode || showDenseDays)) {
        dayEl.classList.add("weekend");
      }

      const num = document.createElement("div");
      num.className = "gantt-header-day-number";
      const monthShort = d.toLocaleDateString("ru-RU", { month: "short" });
      const monthEl = document.createElement("div");
      monthEl.className = "gantt-header-day-month";

      if (isYearMode) {
        if (showDenseDays) {
          num.textContent = String(d.getDate());
          if (d.getDate() === 1) monthEl.textContent = monthShort;
        } else {
          const day = d.getDate();
          if (day === 1) {
            num.textContent = monthShort;
          } else if ([7, 14, 21, 28].includes(day)) {
            num.textContent = String(day);
          } else {
            num.textContent = "";
          }
        }
      } else {
        num.textContent = String(d.getDate());
        monthEl.textContent = monthShort;
      }

      dayEl.appendChild(num);
      if (!isYearMode || showDenseDays) {
        if (monthEl.textContent) dayEl.appendChild(monthEl);
      }

      ganttHeaderRowEl.appendChild(dayEl);
    });

    const visibleEvents = eventsFromTable
      .filter(ev => {
        const key = normalizeDiscipline(ev.discipline);
        if (!activeDisciplines.has(key)) return false;
        const start = parseISODate(ev.startDate);
        const end   = parseISODate(ev.endDate);
        return !(end < rangeStart || start > rangeEnd);
      })
      .sort((a, b) => parseISODate(a.startDate) - parseISODate(b.startDate));

    if (visibleEvents.length === 0) {
      const line = document.createElement("div");
      line.className = "gantt-line";

      const left = document.createElement("div");
      left.className = "gantt-line-left";
      left.textContent = "–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π –≤ —ç—Ç–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ";

      const right = document.createElement("div");
      right.className = "gantt-line-right";
      right.style.width = `${totalWidth}px`;

      line.appendChild(left);
      line.appendChild(right);
      ganttBodyEl.appendChild(line);
      return;
    }

    const weekendIndicesLocal = weekendIndices;

    visibleEvents.forEach(ev => {
      const line = document.createElement("div");
      line.className = "gantt-line";

      const left = document.createElement("div");
      left.className = "gantt-line-left";
      const leftText = document.createElement("span");
      leftText.className = "gantt-line-left-text";
      leftText.textContent = ev.title;
      left.appendChild(leftText);

      const right = document.createElement("div");
      right.className = "gantt-line-right";
      right.style.width = `${totalWidth}px`;

      weekendIndicesLocal.forEach(idx => {
        const stripe = document.createElement("div");
        stripe.className = "gantt-weekend-stripe";
        stripe.style.left = `${idx * ganttDayWidth}px`;
        right.appendChild(stripe);
      });

      const discClass = disciplineToClassName(ev.discipline);

      let startIdx = ganttDayIsos.indexOf(ev.startDate);
      let endIdx   = ganttDayIsos.indexOf(ev.endDate);

      if (startIdx === -1) startIdx = 0;
      if (endIdx   === -1) endIdx   = daysCount - 1;
      if (endIdx < startIdx) endIdx = startIdx;

      const spanDays = Math.max(1, endIdx - startIdx + 1);

      const bar = document.createElement("div");
      bar.className = `gantt-bar ${discClass}`;
      bar.style.left  = `${startIdx * ganttDayWidth}px`;
      bar.style.width = `${spanDays * ganttDayWidth}px`;
      bar.dataset.start = ev.startDate;
      bar.dataset.end   = ev.endDate;
      bar.dataset.title = ev.title;
      bar.textContent = ev.title;

      bar.addEventListener("mouseenter", e => {
        const s  = formatTooltipDate(bar.dataset.start);
        const en = formatTooltipDate(bar.dataset.end);
        const dates = `${s} ‚Äî ${en}`;
        showTooltip(bar.dataset.title, dates, e.clientX, e.clientY);
      });
      bar.addEventListener("mousemove", e => moveTooltip(e.clientX, e.clientY));
      bar.addEventListener("mouseleave", hideTooltip);

      bar.addEventListener("contextmenu", e => {
        if (!isAdmin) return;
        e.preventDefault();
        openEventModal("edit", ev);
      });

      right.appendChild(bar);
      line.appendChild(left);
      line.appendChild(right);
      ganttBodyEl.appendChild(line);
    });

    requestAnimationFrame(adjustGanttRowHeightDynamic);
  }

  function adjustGanttRowHeightDynamic() {
    const BASE = 22;
    const MAX = BASE * 3;

    const lines = ganttBodyEl.children.length;
    if (!lines) {
      document.documentElement.style.setProperty("--gantt-row-height", BASE + "px");
      return;
    }

    const scrollHeight = ganttScrollEl.clientHeight;
    const headerEl = document.querySelector(".gantt-header");
    const headerHeight = headerEl ? headerEl.offsetHeight : 0;
    const available = scrollHeight - headerHeight;

    if (!scrollHeight || available <= 0) {
      document.documentElement.style.setProperty("--gantt-row-height", BASE + "px");
      return;
    }

    const minTotalBase = lines * BASE;
    if (minTotalBase >= available) {
      document.documentElement.style.setProperty("--gantt-row-height", BASE + "px");
      return;
    }

    let candidate = Math.floor(available / lines);
    if (candidate > MAX) candidate = MAX;
    if (candidate < BASE) candidate = BASE;

    document.documentElement.style.setProperty("--gantt-row-height", candidate + "px");
  }

  function adjustCalendarRowHeightDynamic() {
    if (currentView !== "calendar") return;

    const mainEl = document.querySelector(".calendar-main");
    const dayNamesEl = document.querySelector(".day-names");
    if (!mainEl || !dayNamesEl) return;

    const mainHeight = mainEl.clientHeight;
    const dayNamesHeight = dayNamesEl.offsetHeight;

    const available = mainHeight - dayNamesHeight - 8;
    if (available <= 0) return;

    const rows = 6;
    const BASE = calendarBaseRowHeight;
    const MAX  = BASE * 2.8;

    let rowH = Math.floor(available / rows);

    if (rowH < BASE) rowH = BASE;
    if (rowH > MAX)  rowH = MAX;

    document.documentElement
      .style
      .setProperty("--calendar-row-height", rowH + "px");
  }

  function updateViewVisibility(){
    if(currentView==="calendar"){
      calendarViewEl.style.display = "block";
      ganttViewEl.style.display    = "none";
    }else{
      calendarViewEl.style.display = "none";
      ganttViewEl.style.display    = "block";
    }

    document.getElementById("viewCalendarBtn")
      .classList.toggle("view-pill--active",currentView==="calendar");
    document.getElementById("viewGanttBtn")
      .classList.toggle("view-pill--active",currentView==="gantt");

    const ganttRangeToggleEl = document.querySelector(".gantt-range-toggle");
    if(ganttRangeToggleEl){
      ganttRangeToggleEl.style.display = currentView==="gantt" ? "inline-flex" : "none";
    }

    if (zoomControlsEl) {
      zoomControlsEl.style.display = currentView==="gantt" ? "flex" : "none";
    }

    if (currentView === "gantt") {
      requestAnimationFrame(adjustGanttRowHeightDynamic);
    }
  }

  function updateDisciplineFilterButtons(){
    const buttons = document.querySelectorAll("#disciplineFilter .legend-item");
    const allSelected = allDisciplineKeys.every(k=>activeDisciplines.has(k));
    buttons.forEach(btn=>{
      const disc = btn.getAttribute("data-disc");
      if(disc==="all"){
        btn.classList.toggle("legend-item--inactive",!allSelected);
      }else{
        btn.classList.toggle("legend-item--inactive",!activeDisciplines.has(disc));
      }
    });
  }

  function updateGanttRangeControls(){
    document.getElementById("ganttRangeMonthBtn")
      .classList.toggle("view-pill--active",ganttRangeMode==="month");
    document.getElementById("ganttRangeYearBtn")
      .classList.toggle("view-pill--active",ganttRangeMode==="year");
  }

  function updateNavButtonsVisibility(){
    prevMonthBtn.disabled = false;
    nextMonthBtn.disabled = false;
    prevMonthBtn.style.visibility = "visible";
    nextMonthBtn.style.visibility = "visible";
  }

  function handleDisciplineFilterClick(e){
    const btn = e.target.closest(".legend-item");
    if(!btn) return;
    const disc = btn.getAttribute("data-disc");
    if(disc==="all"){
      activeDisciplines = new Set(allDisciplineKeys);
    }else{
      if(activeDisciplines.has(disc)) activeDisciplines.delete(disc);
      else activeDisciplines.add(disc);
    }
    renderCalendar();
  }

  function getZoomLimits() {
    const totalWidth = ganttScrollEl.clientWidth || window.innerWidth || 0;
    const sidebarWidth = getSidebarWidthPx();
    const viewportForDays = Math.max(0, totalWidth - sidebarWidth);

    let minWidth = MIN_GANTT_DAY_WIDTH;
    let maxWidth = 80;

    if (ganttRangeMode === "month" &&
        viewportForDays > 0 &&
        currentGanttDaysCount > 0) {
      const monthFit = viewportForDays / currentGanttDaysCount;
      const weekFit  = viewportForDays / 7;

      minWidth = monthFit;
      maxWidth = weekFit;
    } else if (totalWidth > 0) {
      maxWidth = Math.max(maxWidth, totalWidth / 7);
    }

    if (maxWidth < minWidth) {
      maxWidth = minWidth + 1;
    }

    return { minWidth, maxWidth };
  }
  
  function zoomByFactor(byFactor, pivotClientX = null) {
    if (currentView !== "gantt") return;

    const oldWidth = ganttDayWidth;
    const { minWidth, maxWidth } = getZoomLimits();

    let target = oldWidth * byFactor;
    target = Math.max(minWidth, Math.min(maxWidth, target));

    if (Math.abs(target - oldWidth) < 0.2) return;

    const rect = ganttScrollEl.getBoundingClientRect();
    const pivotOffset =
      pivotClientX != null
        ? pivotClientX - rect.left
        : rect.width / 2;

    const worldBefore = ganttScrollEl.scrollLeft + pivotOffset;

    const scrollTopBefore = ganttScrollEl.scrollTop;

    ganttDayWidth = target;
    applyGanttDayWidth();

    const firstForGantt = new Date(currentYear, currentMonth, 1);
    const lastForGantt  = new Date(currentYear, currentMonth + 1, 0);
    renderGantt(firstForGantt, lastForGantt);

    ganttScrollEl.scrollTop = scrollTopBefore;

    const scale = ganttDayWidth / oldWidth;
    const worldAfter = worldBefore * scale;
    let newScrollLeft = worldAfter - pivotOffset;

    const maxScrollLeft = Math.max(
      0,
      ganttScrollEl.scrollWidth - ganttScrollEl.clientWidth
    );
    if (newScrollLeft < 0) newScrollLeft = 0;
    if (newScrollLeft > maxScrollLeft) newScrollLeft = maxScrollLeft;

    ganttScrollEl.scrollLeft = newScrollLeft;
  }

  function getSidebarWidthPx() {
    const leftHeader = document.querySelector(".gantt-header-left");
    if (!leftHeader) return 0;
    const rect = leftHeader.getBoundingClientRect();
    return rect.width || 0;
  }

  function zoomIn(pivotClientX = null) {
    zoomByFactor(1.15, pivotClientX);
  }

  function zoomOut(pivotClientX = null) {
    zoomByFactor(1 / 1.15, pivotClientX);
  }

  function goPrev() {
    if (currentView === "gantt" && ganttRangeMode === "year") {
      currentYear--;
    } else {
      currentMonth--;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
    }
    renderCalendar();
    if (currentView === "gantt" && ganttRangeMode === "month") {
      fitGanttMonthToViewport();
    }
  }

  function goNext() {
    if (currentView === "gantt" && ganttRangeMode === "year") {
      currentYear++;
    } else {
      currentMonth++;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
    }
    renderCalendar();
    if (currentView === "gantt" && ganttRangeMode === "month") {
      fitGanttMonthToViewport();
    }
  }

  prevMonthBtn.addEventListener("click",goPrev);
  nextMonthBtn.addEventListener("click",goNext);

  document.getElementById("todayBtn").addEventListener("click",()=>{
    currentYear  = today.getFullYear();
    currentMonth = today.getMonth();
    renderCalendar();
    if(currentView==="gantt" && ganttRangeMode==="month"){
      fitGanttMonthToViewport();
    }
  });

  function fitGanttMonthToViewport() {
    if (currentView !== "gantt" || ganttRangeMode !== "month") return;

    const totalWidth = ganttScrollEl.clientWidth || 0;
    const sidebarWidth = getSidebarWidthPx();
    const viewportForDays = Math.max(0, totalWidth - sidebarWidth);

    if (!viewportForDays || !currentGanttDaysCount) return;

    ganttDayWidth = viewportForDays / currentGanttDaysCount;
    applyGanttDayWidth();

    const firstForGantt = new Date(currentYear, currentMonth, 1);
    const lastForGantt  = new Date(currentYear, currentMonth + 1, 0);
    renderGantt(firstForGantt, lastForGantt);
  }

  document.getElementById("viewCalendarBtn").addEventListener("click",()=>{
    currentView="calendar";
    renderCalendar();
  });

  document.getElementById("viewGanttBtn").addEventListener("click", () => {
    currentView = "gantt";
    renderCalendar();
    fitGanttMonthToViewport();
  });

  document.getElementById("ganttRangeMonthBtn").addEventListener("click", () => {
    ganttRangeMode = "month";
    renderCalendar();
    fitGanttMonthToViewport();
  });

  document.getElementById("ganttRangeYearBtn").addEventListener("click", () => {
    ganttRangeMode = "year";
    renderCalendar();
  });

  document.getElementById("disciplineFilter").addEventListener("click",handleDisciplineFilterClick);
  
  zoomInBtn.addEventListener("click", () => {
    const rect = ganttScrollEl.getBoundingClientRect();
    zoomByFactor(1.25, rect.left + rect.width / 2);
  });

  zoomOutBtn.addEventListener("click", () => {
    const rect = ganttScrollEl.getBoundingClientRect();
    zoomByFactor(0.8, rect.left + rect.width / 2);
  });

  ganttScrollEl.addEventListener("wheel", (e) => {
    if (!(e.ctrlKey || e.metaKey)) return;
    e.preventDefault();

    const factor = e.deltaY > 0 ? 0.8 : 1.25;
    zoomByFactor(factor, e.clientX);
  }, { passive: false });

  ganttToggleSidebarBtn.addEventListener("click", () => {
    ganttTableEl.classList.toggle("gantt-sidebar-collapsed");
    if (currentView === "gantt" && ganttRangeMode === "month") {
      fitGanttMonthToViewport();
    }
  });

  window.addEventListener("resize", () => {
    if(currentView==="gantt" && ganttRangeMode==="month"){
      fitGanttMonthToViewport();
    }else{
      renderCalendar();
    }
    if (currentView === "gantt") {
      requestAnimationFrame(adjustGanttRowHeightDynamic);
    }
  });

  // —Å—Ç–∞—Ä—Ç
  updateAdminUI();
applyGanttDayWidth();

const hadCache = loadEventsFromCache();
if (!hadCache) {
  // —Ö–æ—Ç—è –±—ã —Å–µ—Ç–∫–∞ –º–µ—Å—è—Ü–∞ –∏ –ø—É—Å—Ç—ã–µ –¥–Ω–∏, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—â—É—â–µ–Ω–∏—è "—Ç—É–ø–Ω—è–∫–∞"
  renderCalendar();
}

loadEventsFromSheet();
</script>
</body>
</html>